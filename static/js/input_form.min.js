/***************************
 *--    Ready Functin    --*
 ***************************/
$(function(){
  $('.alert .close').click(function(){
    // 1. 隱藏訊息框
    $('.alert').fadeOut();
  });
  $('.account').on('change', function() {
    // account input 提醒檢查帳號, 儲存後無法再更改
    $('.alert .message').html('Please check your account again and cannot be changed after saving.');
    $('.alert').removeClass('alert-danger').removeClass('alert-success').addClass('alert-warning');
    $('.alert').fadeIn();
    setTimeout(function(){
      $('.alert').fadeOut();
    }, 10000);
  });
  $('.save-add-account').click(function(){
    // 1. 檢查'帳號''密碼''確認密碼'不為空值
    // 2. 檢查'帳號'是否符合規則
    // 3. 檢查'密碼'與'確認密碼'為相同
    // 4. 傳遞 account, password, confirm_password, status
    if(check_value('.add-account-form')){
      $('.add-account-form').submit();
    };
  });
  $('.custom-file-input').change(function(){
    // 1. 若有選擇檔案則顯示預覽及顯示檔案名稱, 沒有選擇清空
    $('.custom-file-picture').attr('src', '/static/image/icon-image-w.svg');
    $('.custom-file-label').html('尚未選取檔案');
    $('.custom-file .input-error').hide();
    if(this.files['length'] != 0){
      readFile(this);
    }
  });
  $('.save-edit-account').click(function(){
    // 1. 檢查title為必填
    if(check_value('.edit-account-form')){
      $('.edit-account-form').submit();
    }
  });
  $('.admin-save-change-pwd').click(function(){
    // 1. 檢查'新密碼'與'確認密碼'不為空值
    // 2. 檢查'新密碼'與'確認密碼'為相同
    // 3. 傳遞 user_id, new_password, confirm_new_password
    if(check_value('.admin-change-pwd-form')){
      $('.admin-change-pwd-form').submit();
    }
  });
  $('.save-change-pwd').click(function(){
    // 1. 檢查'當前密碼''新密碼''確認密碼'不為空值
    // 2. 檢查'當前密碼'與'新密碼'為不同
    // 2. 檢查'新密碼'與'確認密碼'為相同
    // 3. 傳遞 user_id, current_password, new_password, confirm_new_password
    if(check_value('.change-pwd-form')){
      $('.change-pwd-form').submit();
    }
  });
  $('.add-product').click(function(){
    // 1. barcode 檢查只能英數
    // 2. product name 檢查必填
    // 3. price 檢查必填, 檢查只能為數字
    if(check_value('.add-product-form')){
      $('.add-product-form').submit();
    }
  });
});
/******************************
 *--    Non-API Function    --*
 ******************************/
function check_value(check_form) {
  var check_obj = {
    "required": {
      "rule": required,
      "bind_class": ".required",
      "error_message": "This field is required."
    },
    "different_value": {
      "rule": different_value,
      "bind_class": ".different_value",
      "error_message": "Same as the current password."
    },
    "same_value": {
      "rule": same_value,
      "bind_class": ".same_value",
      "error_message": "The contents of the fields are inconsistent."
    },
    "string_length": {
      "rule": string_length,
      "bind_class": ".string_length",
      "error_message": "String over length."
    },
    "is_number": {
      "rule": is_number,
      "bind_class": ".is_number",
      "error_message": "Only numbers can be entered."
    },
    "is_english_number": {
      "rule": is_english_number,
      "bind_class": ".is_english_number",
      "error_message": "Only English and numbers can be entered."
    }
  }
  var check_items = 0;
  $(check_form+' .required').each(function(){
    if(check_obj['required']['rule']($(this).val())){
      render_input_status($(this), true, '');
    }else{
      render_input_status($(this), false, check_obj['required']['error_message']);
      check_items++;
      return;
    }
  });
  if(check_items == 0){
    $(check_form+' .different_value').each(function(){
      if(check_obj['different_value']['rule']()){
        render_input_status($(this), true, '');
      }else{
        render_input_status($(this), false, check_obj['different_value']['error_message']);
        check_items++;
        return;
      }
    });
  }
  if(check_items == 0){
    $(check_form+' .same_value').each(function(){
      if(check_obj['same_value']['rule']()){
        render_input_status($(this), true, '');
      }else{
        render_input_status($(this), false, check_obj['same_value']['error_message']);
        check_items++;
        return;
      }
    });
  }
  if(check_items == 0){
    $(check_form+' .string_length').each(function(){
      if(check_obj['string_length']['rule']($(this).val())){
        render_input_status($(this), true, '');
      }else{
        render_input_status($(this), false, check_obj['string_length']['error_message']);
        check_items++;
        return;
      }
    });
  }
  if(check_items == 0){
    $(check_form+' .is_number').each(function(){
      if(check_obj['is_number']['rule']($(this).val())){
        render_input_status($(this), true, '');
      }else{
        render_input_status($(this), false, check_obj['is_number']['error_message']);
        check_items++;
        return;
      }
    });
  }
  if(check_items == 0){
    $(check_form+' .is_english_number').each(function(){
      if(check_obj['is_english_number']['rule']($(this).val())){
        render_input_status($(this), true, '');
      }else{
        render_input_status($(this), false, check_obj['is_english_number']['error_message']);
        check_items++;
        return;
      }
    });
  }
  if(check_items == 0){
    return true;
  }
}
// 顯示input error
function render_input_status(input, status, message){
  input.addClass('is-invalid');
  input.next().next().html(message);
  input.next().next().show();
  if(status){
    input.removeClass('is-invalid');
    input.next().next().html('');
    input.next().next().hide();
  }
}
function readFile(input){
  if(input.files && input.files[0]){
    var reader = new FileReader();
    reader.onload = function(e){
      $('.custom-file-picture').attr('src', e.target.result);
    }
    $('.custom-file-label').html(input.files[0].name);
  }
  reader.readAsDataURL(input.files[0]);
}
function alertMessage(data, status){
  $('.alert .message').html('');
  if(status){
    $('.alert .message').html(data.message);
    $('.alert').removeClass('alert-danger').removeClass('alert-warning').addClass('alert-success');
    $('.modal').removeClass('show').slideUp(300);
    $('.modal-backdrop').remove();
  }else{
    $('.alert .message').html(data.status + ' ' + data.statusText);
    $('.alert').removeClass('alert-success').removeClass('alert-warning').addClass('alert-danger');
  }
  $('.alert').fadeIn();
  setTimeout(function(){
    $('.alert').fadeOut();
  }, 3000);
}